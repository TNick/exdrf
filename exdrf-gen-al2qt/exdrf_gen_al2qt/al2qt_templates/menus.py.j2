# This file was automatically generated using the exdrf_gen package.
# Source: {{ source_module }} -> {{ source_templ }}
# Don't change it manually.
import logging
from functools import partial
from typing import TYPE_CHECKING, Dict, List

from exdrf_qt.controls.crud_actions import follow_create_route, follow_list_route
from exdrf_qt.controls.seldb.sel_db import SelectDatabaseDlg
from exdrf_qt.menus import ActionDef, DefBase, MenuDef
from exdrf_qt.plugins import exdrf_qt_pm, hook_impl
from PyQt5.QtWidgets import QAction, QMenu

# exdrf-keep-start other_imports ----------------------------------------------
{{other_imports}}
# exdrf-keep-end other_imports ------------------------------------------------

if TYPE_CHECKING:
    from exdrf_qt.context import QtContext  # noqa: F401

logger = logging.getLogger(__name__)
# exdrf-keep-start other_globals ----------------------------------------------
{{other_globals}}
# exdrf-keep-end other_globals ------------------------------------------------


class ExdrfMenus:
    """Contains all the actions and menus for the application.

    This class implements the create_extra_main_menu_defs hook to provide
    menu definitions for all resources. The hook is automatically registered
    when the class is instantiated.
    """

    ctx: "QtContext"
    _created: Dict[str, "QAction"]

    # exdrf-keep-start other_menus_attributes ---------------------------------
{{other_menus_attributes}}
    # exdrf-keep-end other_menus_attributes -----------------------------------

    def __init__(self, ctx: "QtContext", parent: QMenu = None):
        """Initialize the menus.

        Args:
            ctx: The Qt context for accessing translations, icons, and database
                connections.
            parent: Optional parent menu (deprecated, not used with hook system).
        """
        self.ctx = ctx
        self._created = {}

        # Register this instance as a plugin to provide menu definitions.
        exdrf_qt_pm.register(self, name="exdrf_menus")

        # exdrf-keep-start extra_menus_init -----------------------------------
{{extra_menus_init}}
        # exdrf-keep-end extra_menus_init -------------------------------------

    @property
    def show_conn_settings_ac(self) -> "QAction":
        """Get the connection settings action from the created dictionary."""
        return self._created.get("show_conn_settings")  # type: ignore

    @hook_impl()
    def create_extra_main_menu_defs(  # type: ignore
        self, ctx: "QtContext"  # type: ignore
    ) -> List["DefBase"]:
        """Hook implementation that provides menu definitions for all resources.

        Args:
            ctx: The Qt context for accessing translations, icons, and database
                connections.

        Returns:
            List[DefBase]: A list of menu and action definitions.
        """
        result: List["DefBase"] = []

        # Create menu definitions for each category.
        {% for name, c_res in categ_map.items() %}
        result.append(
            MenuDef(
                key="{{ name }}-menu",
                label=ctx.t("menus.{{ name }}.t", "{{ name.title() }}"),
                parent=("concerns-menu",),
                rules=(),
            )
        )

        # Create action definitions for each resource in this category.
        {% for res_name in sorted_resources_for_ui(dset, c_res) %}
        {%- set mdl = dset[res_name] %}
        route_{{ mdl.snake_case_name }} = "exdrf://navigation/resource/{{ mdl.pascal_case_name }}"
        route_create_{{ mdl.snake_case_name }} = "exdrf://navigation/resource/{{ mdl.pascal_case_name }}/create"
        
        # List action (shown in menu)
        result.append(
            ActionDef(
                key="open_{{ mdl.snake_case_name }}_list",
                label=ctx.t(
                    "menus.{{ name }}.{{ mdl.snake_case_name }}.list.t",
                    "{{ mdl.text_name }} list"
                ),
                parent=("{{ name }}-menu",),
                rules=(),
                callback=partial(follow_list_route, ctx=ctx, route=route_{{ mdl.snake_case_name }}),
            )
        )
        
        # Create action (not shown in menu, available via command palette)
        result.append(
            ActionDef(
                key="create_{{ mdl.snake_case_name }}",
                label=ctx.t(
                    "menus.{{ name }}.{{ mdl.snake_case_name }}.create.t",
                    "Create {{ mdl.text_name }}"
                ),
                parent=(),
                rules=(),
                callback=partial(follow_create_route, ctx=ctx, route=route_create_{{ mdl.snake_case_name }}),
                description=ctx.t(
                    "menus.{{ name }}.{{ mdl.snake_case_name }}.create.d",
                    "Create a new {{ mdl.text_name }}"
                ),
                no_menu=True,
            )
        )
        {%- endfor %}
        {% endfor %}

        # Add connection settings action at the end of concerns menu.
        result.append(
            ActionDef(
                key="show_conn_settings",
                label=ctx.t(
                    "menus.connection_settings.t", "Connection settings"
                ),
                description=ctx.t(
                    "menus.connection_settings.d",
                    "Define connection parameters and save them for later "
                    "use.\n"
                    "The database can also be initialized from this dialog."
                ),
                parent=("concerns-menu",),
                rules=(),
                callback=partial(
                    SelectDatabaseDlg.change_connection_str, ctx
                ),  # type: ignore
            )
        )

        return result

    def adjust_icons(self, created: Dict[str, "QAction"]):
        """Adjust icons for actions after they have been created.

        This method can be overridden or extended to customize icons for
        specific actions. The created dictionary maps action keys to QAction
        instances.

        Args:
            created: Dictionary mapping action keys to created QAction instances.
        """
        # Store reference to created dictionary for property access.
        self._created = created

        # exdrf-keep-start adjust_icons_content ---------------------------------
        # Override this section to customize icons.
        # Example:
        # if "open_immobile_list" in created:
        #     created["open_immobile_list"].setIcon(self.ctx.get_icon("c_land"))
        # exdrf-keep-end adjust_icons_content -----------------------------------

    # exdrf-keep-start extra_menus_content ------------------------------------
{{extra_menus_content}}
    # exdrf-keep-end extra_menus_content --------------------------------------

# exdrf-keep-start more_content ------------------------------------------------
{{more_content}}
# exdrf-keep-end more_content --------------------------------------------------
{{- "\n" -}}
