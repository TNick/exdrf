# This file was automatically generated using the exdrf_gen package.
# Source: {{ source_module }} -> {{ source_templ }}
# Don't change it manually.

from attrs import define, field
from typing import TYPE_CHECKING, Any, Dict
from exdrf_xl.table import XlTable
from exdrf_xl.column import XlColumn
from sqlalchemy import select

if TYPE_CHECKING:
    from sqlalchemy.sql import Select  # noqa: F401
    from sqlalchemy.orm import Session  # noqa: F401
    from {{ db_module }}.{{ r.categories[0] }}.api \
        import {{ ResPascal }} as Db{{ ResPascal }}  # noqa: F401


# exdrf-keep-start other_imports ----------------------------------------------
{{other_imports}}
# exdrf-keep-end other_imports ------------------------------------------------

# exdrf-keep-start other_globals ----------------------------------------------
{{other_globals}}
# exdrf-keep-end other_globals ------------------------------------------------

{% for field in sorted_fields(r) %}
@define(slots=True, kw_only=True)
class {{ field.pascal_case_name }}Col(XlColumn["{{ ResPascal }}", "Db{{ ResPascal }}"]):
    table: "{{ ResPascal }}" = field(init=False, default=None)
    xl_name: str = field(init=False, default="{{ field.name }}")
    primary: bool = field(default={{ field.primary }}, repr=False)

    def value_from_record(self, record: "Db{{ ResPascal }}") -> Any:
        {%- if field.is_ref_type %}
        return None
        {%- else %}
        return record.{{ field.name }}
        {%- endif %}

    {%- if field.is_ref_type %}
    def is_included(self) -> bool:
        return False
    
    def apply_xl_to_db(
        self, session: "Session", db_rec: "Db{{ ResPascal }}", xl_value: Any
    ):
        pass
    {%- else %}
    def apply_xl_to_db(
        self, session: "Session", db_rec: "Db{{ ResPascal }}", xl_value: Any
    ):
        db_rec.{{ field.name }} = xl_value
    {%- endif %}

{% endfor %}

def _create_columns():
    return [
    {%- for field in sorted_fields(r) %}
        {{ field.pascal_case_name }}Col(),
    {%- endfor %}
    ]


@define(slots=True, kw_only=True)
class {{ ResPascal }}(XlTable):{%- if r.description %}
    """{%- for line in r.description.split('\n') -%}
    {%- if loop.first -%}
    {{ line + '\n' }}
    {%- else -%}
    {{ '    ' + line + '\n' }}
    {%- endif -%}
    {%- endfor %}
    """{%- endif %}
    sheet_name: str = field(init=False, default="{{ res_snake }}")
    xl_name: str = field(init=False, default="{{ res_snake }}")
    columns: list[XlColumn] = field(factory=_create_columns)
    pks: list[str] = (
        {%- for field in sorted_fields(r) %}
        {%- if field.primary %}
        '{{ field.name }}',
        {%- endif %}
        {%- endfor %}
    )

    # exdrf-keep-start other_attributes ---------------------------------------
{{other_attributes}}
    # exdrf-keep-end other_attributes -----------------------------------------

    def get_selector(self) -> "Select":
        from {{ db_module }}.{{ r.categories[0] }}.api \
            import {{ ResPascal }} as Db{{ ResPascal }}
        return select(Db{{ ResPascal }})

    def find_db_rec(
        self,
        session: "Session",
        xl_rec: Dict[str, Any],
        is_db_pk: Callable[[Any], bool]
    ) -> "Db{{ ResPascal }} | None":
        from {{ db_module }}.{{ r.categories[0] }}.api \
            import {{ ResPascal }} as Db{{ ResPascal }}

        {%- for field in sorted_fields(r) %}
        {%- if field.primary %}

        v_{{ field.name }} = xl_rec.get('{{ field.name }}', None)
        if v_{{ field.name }} is None or (
            isinstance(v_{{ field.name }}, str)
            and v_{{ field.name }} == ''
        ):
            raise ValueError(
                'Property `{{ field.name }}` is part of the primary '
                'key set of the `{{ ResPascal }}` table and cannot be empty.'
            )
        if not is_db_pk(v_{{ field.name }}):
            return None
        {%- endif %}
        {%- endfor %}

        result = session.scalar(
            select(Db{{ ResPascal }}).where(
            {%- for field in sorted_fields(r) %}
            {%- if field.primary %}
                Db{{ ResPascal }}.{{ field.name }} == v_{{ field.name }},
            {%- endif %}
            {%- endfor %}
            )
        )
        return result

    def create_new_db_record(
        self, session: "Session", xl_rec: Dict[str, Any]
    ) -> "Db{{ ResPascal }}":
        from {{ db_module }}.{{ r.categories[0] }}.api \
            import {{ ResPascal }} as Db{{ ResPascal }}
        return Db{{ ResPascal }}()
        

    # exdrf-keep-start extra_class_content -------------------------------------
{{extra_fumo_content}}
    # exdrf-keep-end extra_class_content ---------------------------------------


# exdrf-keep-start more_content -----------------------------------------------
{{more_content}}
# exdrf-keep-end more_content -------------------------------------------------
{{- "\n" -}}
